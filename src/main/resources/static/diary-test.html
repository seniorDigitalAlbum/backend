<!DOCTYPE html>

<html lang="ko">

<head>

    <meta charset="UTF-8">

    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <title>ì¼ê¸° ìƒì„± í…ŒìŠ¤íŠ¸</title>

    <!-- YouTube Player API -->

    <script src="https://www.youtube.com/iframe_api"></script>

    <style>

        body {

            font-family: Arial, sans-serif;

            max-width: 1200px;

            margin: 0 auto;

            padding: 20px;

            background-color: #f5f5f5;

        }

        .container {

            background: white;

            padding: 30px;

            border-radius: 10px;

            box-shadow: 0 2px 10px rgba(0,0,0,0.1);

            margin-bottom: 20px;

        }

        h1 {

            color: #333;

            text-align: center;

            margin-bottom: 30px;

        }

        .section {

            margin-bottom: 30px;

            padding: 20px;

            border: 1px solid #ddd;

            border-radius: 8px;

            background-color: #fafafa;

        }

        .section h2 {

            color: #555;

            margin-top: 0;

            border-bottom: 2px solid #007bff;

            padding-bottom: 10px;

        }

        input, button {

            padding: 10px;

            margin: 5px;

            border: 1px solid #ddd;

            border-radius: 5px;

        }

        input {

            width: 200px;

        }

        button {

            background-color: #007bff;

            color: white;

            border: none;

            cursor: pointer;

            padding: 10px 20px;

            border-radius: 5px;

        }

        button:hover {

            background-color: #0056b3;

        }

        button:disabled {

            background-color: #ccc;

            cursor: not-allowed;

        }

        .result {

            background-color: #f8f9fa;

            border: 1px solid #e9ecef;

            border-radius: 5px;

            padding: 15px;

            margin-top: 15px;

            white-space: pre-wrap;

            font-family: monospace;

            max-height: 400px;

            overflow-y: auto;

        }

        .status {

            padding: 10px;

            border-radius: 5px;

            margin: 10px 0;

            font-weight: bold;

        }

        .status.processing {

            background-color: #fff3cd;

            color: #856404;

            border: 1px solid #ffeaa7;

        }

        .status.completed {

            background-color: #d4edda;

            color: #155724;

            border: 1px solid #c3e6cb;

        }

        .status.error {

            background-color: #f8d7da;

            color: #721c24;

            border: 1px solid #f5c6cb;

        }

        .diary-content {

            background-color: #e7f3ff;

            border: 1px solid #b3d9ff;

            border-radius: 8px;

            padding: 20px;

            margin: 15px 0;

            line-height: 1.6;

        }

        .music-item {

            background-color: #f8f9fa;

            border: 1px solid #e9ecef;

            border-radius: 8px;

            padding: 15px;

            margin: 10px 0;

            transition: all 0.3s ease;

            cursor: pointer;

        }

        .music-item:hover {

            background-color: #e9ecef;

            transform: translateY(-2px);

            box-shadow: 0 4px 8px rgba(0,0,0,0.1);

        }

        .music-item.active {

            border-left: 4px solid #28a745;

            background-color: #e8f5e8;

        }

        .play-btn {

            background-color: #28a745;

            color: white;

            border: none;

            padding: 8px 16px;

            border-radius: 5px;

            cursor: pointer;

            font-size: 14px;

            margin-top: 10px;

        }

        .play-btn:hover {

            background-color: #218838;

        }

        

        /* YouTube Player Styles */

        .music-player {

            position: fixed;

            bottom: 0;

            left: 0;

            right: 0;

            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);

            color: white;

            padding: 20px;

            box-shadow: 0 -4px 20px rgba(0,0,0,0.3);

            z-index: 1000;

            display: none;

        }

        .player-content {

            max-width: 1200px;

            margin: 0 auto;

            display: flex;

            align-items: center;

            gap: 20px;

        }

        .player-info {

            flex: 1;

        }

        .player-info h3 {

            margin: 0 0 5px 0;

            font-size: 18px;

        }

        .player-info p {

            margin: 0;

            opacity: 0.8;

            font-size: 14px;

        }

        .player-controls {

            display: flex;

            align-items: center;

            gap: 15px;

        }

        .control-btn {

            background: rgba(255,255,255,0.2);

            border: none;

            color: white;

            padding: 10px;

            border-radius: 50%;

            cursor: pointer;

            font-size: 16px;

            width: 40px;

            height: 40px;

            display: flex;

            align-items: center;

            justify-content: center;

            transition: all 0.3s ease;

        }

        .control-btn:hover {

            background: rgba(255,255,255,0.3);

            transform: scale(1.1);

        }

        .control-btn:disabled {

            opacity: 0.5;

            cursor: not-allowed;

        }

        .playlist-indicator {

            background: rgba(255,255,255,0.2);

            padding: 5px 10px;

            border-radius: 15px;

            font-size: 12px;

        }

        .close-player {

            background: rgba(255,255,255,0.2);

            border: none;

            color: white;

            padding: 8px 12px;

            border-radius: 5px;

            cursor: pointer;

            font-size: 14px;

        }

        .close-player:hover {

            background: rgba(255,255,255,0.3);

        }

        .summary-content {

            background-color: #f0f8f0;

            border: 1px solid #c3e6c3;

            border-radius: 8px;

            padding: 15px;

            margin: 15px 0;

            line-height: 1.5;

        }

    </style>

</head>

<body>

    <div class="container">

        <h1>ğŸ“– ì¼ê¸° ìƒì„± í…ŒìŠ¤íŠ¸</h1>

        

        <!-- 0. í…ŒìŠ¤íŠ¸ ë°ì´í„° ìƒì„± -->

        <div class="section">

            <h2>0ï¸âƒ£ í…ŒìŠ¤íŠ¸ ë°ì´í„° ìƒì„±</h2>

            <p>ì¼ê¸° í…ŒìŠ¤íŠ¸ë¥¼ ìœ„í•œ ìƒ˜í”Œ ëŒ€í™” ë°ì´í„°ë¥¼ ìƒì„±í•©ë‹ˆë‹¤.</p>

            <button onclick="createTestData()">í…ŒìŠ¤íŠ¸ ë°ì´í„° ìƒì„±</button>

            <div id="testDataResult" class="result" style="display: none;"></div>

        </div>

        

        <!-- 1. ëŒ€í™” ì¢…ë£Œ -->

        <div class="section">

            <h2>1ï¸âƒ£ ëŒ€í™” ì¢…ë£Œ</h2>

            <p>ëŒ€í™”ë¥¼ ì¢…ë£Œí•˜ê³  ë°±ê·¸ë¼ìš´ë“œì—ì„œ ìš”ì•½ ë° ì¼ê¸° ìƒì„±ì„ ì‹œì‘í•©ë‹ˆë‹¤.</p>

            <input type="number" id="conversationId" placeholder="ëŒ€í™” ID" value="1">

            <button onclick="endConversation()">ëŒ€í™” ì¢…ë£Œ</button>

            <div id="endResult" class="result" style="display: none;"></div>

        </div>

        

        <!-- 2. ì²˜ë¦¬ ìƒíƒœ í™•ì¸ -->

        <div class="section">

            <h2>2ï¸âƒ£ ì²˜ë¦¬ ìƒíƒœ í™•ì¸</h2>

            <p>ìš”ì•½ ë° ì¼ê¸° ìƒì„± ì§„í–‰ ìƒíƒœë¥¼ í™•ì¸í•©ë‹ˆë‹¤.</p>

            <button onclick="checkStatus()">ìƒíƒœ í™•ì¸</button>

            <button onclick="startPolling()">ìë™ í´ë§ ì‹œì‘</button>

            <button onclick="stopPolling()">í´ë§ ì¤‘ì§€</button>

            <div id="statusResult" class="result" style="display: none;"></div>

            <div id="statusDisplay" class="status" style="display: none;"></div>

        </div>

        

        <!-- 3. ì¼ê¸° ì¡°íšŒ -->

        <div class="section">

            <h2>3ï¸âƒ£ ì¼ê¸° ì¡°íšŒ</h2>

            <p>ìƒì„±ëœ ì¼ê¸°ì™€ ìš”ì•½ ë‚´ìš©ì„ ì¡°íšŒí•©ë‹ˆë‹¤.</p>

            <button onclick="getDiary()" id="diaryBtn" disabled>ì¼ê¸° ë³´ëŸ¬ ê°€ê¸°</button>

            <div id="diaryResult" class="result" style="display: none;"></div>

            <div id="diaryContent" style="display: none;"></div>

            <div id="musicRecommendations" style="display: none;">

                <h3>ğŸµ ì¶”ì²œ ìŒì•…</h3>

                <div id="musicList"></div>

            </div>

        </div>

    </div>



    <!-- Hidden YouTube Player -->

    <div id="player" style="display: none;"></div>



    <!-- Music Player -->

    <div id="musicPlayer" class="music-player">

        <div class="player-content">

            <div class="player-info">

                <h3 id="playerTitle">ìŒì•… ì œëª©</h3>

                <p id="playerArtist">ì•„í‹°ìŠ¤íŠ¸</p>

            </div>

            <div class="player-controls">

                <button class="control-btn" id="prevBtn" onclick="playPrevious()" title="ì´ì „ ê³¡">â®</button>

                <button class="control-btn" id="playPauseBtn" onclick="togglePlayPause()" title="ì¬ìƒ/ì¼ì‹œì •ì§€">â–¶</button>

                <button class="control-btn" id="nextBtn" onclick="playNext()" title="ë‹¤ìŒ ê³¡">â­</button>

                <div class="playlist-indicator" id="playlistIndicator">1/3</div>

            </div>

            <button class="close-player" onclick="closePlayer()">ë‹«ê¸°</button>

        </div>

    </div>



    <script>

        let pollingInterval = null;

        let conversationId = null;

        

        // YouTube Player ê´€ë ¨ ë³€ìˆ˜

        let player = null;

        let currentPlaylist = [];

        let currentTrackIndex = 0;

        let isPlaying = false;

        

        // YouTube Player API ì´ˆê¸°í™”

        function onYouTubeIframeAPIReady() {

            console.log('YouTube Player API ì¤€ë¹„ ì™„ë£Œ');

        }

        

        // 0. í…ŒìŠ¤íŠ¸ ë°ì´í„° ìƒì„±

        async function createTestData() {

            try {

                const response = await fetch('/api/test/conversation', {

                    method: 'POST'

                });

                

                const result = await response.text();

                

                const resultDiv = document.getElementById('testDataResult');

                resultDiv.style.display = 'block';

                resultDiv.className = 'result success';

                resultDiv.textContent = result;

                

                // ìƒì„±ëœ ëŒ€í™” ID ì¶”ì¶œ (ì˜ˆ: "Conversation ID: 123")

                const match = result.match(/Conversation ID: (\d+)/);

                if (match) {

                    const newConversationId = match[1];

                    document.getElementById('conversationId').value = newConversationId;

                    conversationId = newConversationId;

                }

                

            } catch (error) {

                const resultDiv = document.getElementById('testDataResult');

                resultDiv.style.display = 'block';

                resultDiv.className = 'result error';

                resultDiv.textContent = 'ì˜¤ë¥˜: ' + error.message;

            }

        }

        

        // 1. ëŒ€í™” ì¢…ë£Œ

        async function endConversation() {

            conversationId = document.getElementById('conversationId').value;

            if (!conversationId) {

                alert('ëŒ€í™” IDë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');

                return;

            }

            

            try {

                const response = await fetch(`/api/conversations/${conversationId}/end`, {

                    method: 'PUT'

                });

                

                const data = await response.json();

                

                document.getElementById('endResult').style.display = 'block';

                document.getElementById('endResult').textContent = JSON.stringify(data, null, 2);

                

                if (data.success) {

                    // ëŒ€í™” ë©”ì‹œì§€ í‘œì‹œ

                    displayMessages(data.messages);

                    

                    // í´ë§ ì‹œì‘

                    startPolling();

                }

                

            } catch (error) {

                document.getElementById('endResult').style.display = 'block';

                document.getElementById('endResult').textContent = 'ì˜¤ë¥˜: ' + error.message;

            }

        }

        

        // ëŒ€í™” ë©”ì‹œì§€ í‘œì‹œ

        function displayMessages(messages) {

            const endResult = document.getElementById('endResult');

            endResult.innerHTML = '<h3>ğŸ“ ëŒ€í™” ë‚´ìš©</h3>';

            

            messages.forEach((message, index) => {

                const messageDiv = document.createElement('div');

                messageDiv.style.marginBottom = '10px';

                messageDiv.style.padding = '10px';

                messageDiv.style.borderRadius = '5px';

                messageDiv.style.backgroundColor = message.senderType === 'USER' ? '#e3f2fd' : '#f3e5f5';

                

                const sender = message.senderType === 'USER' ? 'ğŸ‘¤ ì‚¬ìš©ì' : 'ğŸ¤– AI';

                messageDiv.innerHTML = `<strong>${sender}:</strong> ${message.content}`;

                

                endResult.appendChild(messageDiv);

            });

        }

        

        // 2. ì²˜ë¦¬ ìƒíƒœ í™•ì¸

        async function checkStatus() {

            if (!conversationId) {

                conversationId = document.getElementById('conversationId').value;

            }

            

            if (!conversationId) {

                alert('ëŒ€í™” IDë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');

                return;

            }

            

            try {

                const response = await fetch(`/api/conversations/${conversationId}/processing-status`);

                const data = await response.json();

                

                document.getElementById('statusResult').style.display = 'block';

                document.getElementById('statusResult').textContent = JSON.stringify(data, null, 2);

                

                // ìƒíƒœ í‘œì‹œ

                const statusDisplay = document.getElementById('statusDisplay');

                statusDisplay.style.display = 'block';

                statusDisplay.className = 'status';

                

                if (data.status === 'PROCESSING') {

                    statusDisplay.classList.add('processing');

                    statusDisplay.textContent = 'â³ ' + data.message;

                } else if (data.status === 'COMPLETED') {

                    statusDisplay.classList.add('completed');

                    statusDisplay.textContent = 'âœ… ' + data.message;

                    

                    // ì¼ê¸° ë²„íŠ¼ í™œì„±í™”

                    document.getElementById('diaryBtn').disabled = false;

                    

                    // í´ë§ ì¤‘ì§€

                    stopPolling();

                } else if (data.status === 'ERROR') {

                    statusDisplay.classList.add('error');

                    statusDisplay.textContent = 'âŒ ' + data.message;

                    stopPolling();

                }

                

            } catch (error) {

                document.getElementById('statusResult').style.display = 'block';

                document.getElementById('statusResult').textContent = 'ì˜¤ë¥˜: ' + error.message;

            }

        }

        

        // í´ë§ ì‹œì‘

        function startPolling() {

            if (pollingInterval) {

                clearInterval(pollingInterval);

            }

            

            pollingInterval = setInterval(checkStatus, 2000); // 2ì´ˆë§ˆë‹¤ í™•ì¸

            console.log('í´ë§ ì‹œì‘ë¨');

        }

        

        // í´ë§ ì¤‘ì§€

        function stopPolling() {

            if (pollingInterval) {

                clearInterval(pollingInterval);

                pollingInterval = null;

                console.log('í´ë§ ì¤‘ì§€ë¨');

            }

        }

        

        // 3. ì¼ê¸° ì¡°íšŒ

        async function getDiary() {

            if (!conversationId) {

                conversationId = document.getElementById('conversationId').value;

            }

            

            if (!conversationId) {

                alert('ëŒ€í™” IDë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');

                return;

            }

            

            try {

                const response = await fetch(`/api/conversations/${conversationId}/diary`);

                const data = await response.json();

                

                document.getElementById('diaryResult').style.display = 'block';

                document.getElementById('diaryResult').textContent = JSON.stringify(data, null, 2);

                

                if (data.success) {

                    // ì¼ê¸° ë‚´ìš© í‘œì‹œ

                    const diaryContent = document.getElementById('diaryContent');

                    diaryContent.style.display = 'block';

                    

                    let emotionHtml = '';

                    if (data.emotionSummary) {

                        emotionHtml = `

                            <h3>ğŸ˜Š ê°ì • ë¶„ì„ ìš”ì•½</h3>

                            <div class="summary-content">

                                <p><strong>ì£¼ìš” ê°ì •:</strong> ${data.emotionSummary.dominantEmotion}</p>

                                <p><strong>í‰ê·  ì‹ ë¢°ë„:</strong> ${data.emotionSummary.averageConfidence.toFixed(2)}</p>

                                <p><strong>ë¶„ì„ëœ ë©”ì‹œì§€ ìˆ˜:</strong> ${data.emotionSummary.analyzedMessageCount}</p>

                                <p><strong>ê°ì • ë¶„í¬:</strong> ${JSON.stringify(data.emotionSummary.emotionCounts)}</p>

                            </div>

                        `;

                    }

                    

                    diaryContent.innerHTML = `

                        <h3>ğŸ“‹ ëŒ€í™” ìš”ì•½</h3>

                        <div class="summary-content">${data.summary}</div>

                        

                        <h3>ğŸ“– ìƒì„±ëœ ì¼ê¸°</h3>

                        <div class="diary-content">${data.diary}</div>

                        

                        ${emotionHtml}

                    `;

                    

                    // ìŒì•… ì¶”ì²œ í‘œì‹œ

                    if (data.musicRecommendations && data.musicRecommendations.length > 0) {

                        displayMusicRecommendations(data.musicRecommendations);

                        // í”Œë ˆì´ë¦¬ìŠ¤íŠ¸ ì„¤ì •

                        currentPlaylist = data.musicRecommendations;

                    }

                }

                

            } catch (error) {

                document.getElementById('diaryResult').style.display = 'block';

                document.getElementById('diaryResult').textContent = 'ì˜¤ë¥˜: ' + error.message;

            }

        }

        

        // ìŒì•… ì¶”ì²œ í‘œì‹œ

        function displayMusicRecommendations(musicList) {

            const musicDiv = document.getElementById('musicRecommendations');

            const musicListDiv = document.getElementById('musicList');

            

            musicDiv.style.display = 'block';

            

            let html = '';

            musicList.forEach((music, index) => {

                html += `

                    <div class="music-item" onclick="playTrack(${index})">

                        <h4>ğŸµ ${music.title} - ${music.artist}</h4>

                        <p><strong>ë¶„ìœ„ê¸°:</strong> ${music.mood}</p>

                        <button onclick="event.stopPropagation(); playTrack(${index})" class="play-btn">

                            â–¶ï¸ ì¬ìƒí•˜ê¸°

                        </button>

                    </div>

                `;

            });

            

            musicListDiv.innerHTML = html;

        }

        

        // íŠ¸ë™ ì¬ìƒ

        function playTrack(index) {

            if (!currentPlaylist || currentPlaylist.length === 0) {

                alert('ì¬ìƒí•  ìŒì•…ì´ ì—†ìŠµë‹ˆë‹¤.');

                return;

            }

            

            currentTrackIndex = index;

            const track = currentPlaylist[index];

            

            if (!track.youtubeVideoId) {

                alert('ì´ ìŒì•…ì˜ YouTube IDë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');

                return;

            }

            

            // í”Œë ˆì´ì–´ í‘œì‹œ

            showPlayer();

            updatePlayerInfo(track, index);

            

            // YouTube Player ìƒì„± ë˜ëŠ” ì—…ë°ì´íŠ¸

            if (player) {

                player.loadVideoById(track.youtubeVideoId);

            } else {

                createYouTubePlayer(track.youtubeVideoId);

            }

            

            // í™œì„± íŠ¸ë™ í‘œì‹œ

            updateActiveTrack(index);

        }

        

        // YouTube Player ìƒì„±

        function createYouTubePlayer(videoId) {

            if (player) {

                player.destroy();

            }

            

            player = new YT.Player('player', {

                height: '0',

                width: '0',

                videoId: videoId,

                playerVars: {

                    'autoplay': 1,

                    'controls': 0,

                    'disablekb': 1,

                    'enablejsapi': 1,

                    'fs': 0,

                    'iv_load_policy': 3,

                    'modestbranding': 1,

                    'playsinline': 1,

                    'rel': 0,

                    'showinfo': 0

                },

                events: {

                    'onReady': onPlayerReady,

                    'onStateChange': onPlayerStateChange

                }

            });

        }

        

        // Player ì¤€ë¹„ ì™„ë£Œ

        function onPlayerReady(event) {

            console.log('YouTube Player ì¤€ë¹„ ì™„ë£Œ');

            isPlaying = true;

            updatePlayPauseButton();

        }

        

        // Player ìƒíƒœ ë³€ê²½

        function onPlayerStateChange(event) {

            if (event.data === YT.PlayerState.PLAYING) {

                isPlaying = true;

            } else if (event.data === YT.PlayerState.PAUSED) {

                isPlaying = false;

            } else if (event.data === YT.PlayerState.ENDED) {

                isPlaying = false;

                // ìë™ìœ¼ë¡œ ë‹¤ìŒ ê³¡ ì¬ìƒ

                playNext();

            }

            updatePlayPauseButton();

        }

        

        // í”Œë ˆì´ì–´ í‘œì‹œ

        function showPlayer() {

            document.getElementById('musicPlayer').style.display = 'block';

            document.body.style.paddingBottom = '120px'; // í”Œë ˆì´ì–´ ê³µê°„ í™•ë³´

        }

        

        // í”Œë ˆì´ì–´ ìˆ¨ê¸°ê¸°

        function closePlayer() {

            document.getElementById('musicPlayer').style.display = 'none';

            document.body.style.paddingBottom = '0';

            if (player) {

                player.pauseVideo();

            }

        }

        

        // í”Œë ˆì´ì–´ ì •ë³´ ì—…ë°ì´íŠ¸

        function updatePlayerInfo(track, index) {

            document.getElementById('playerTitle').textContent = track.title;

            document.getElementById('playerArtist').textContent = track.artist;

            document.getElementById('playlistIndicator').textContent = `${index + 1}/${currentPlaylist.length}`;

        }

        

        // ì¬ìƒ/ì¼ì‹œì •ì§€ í† ê¸€

        function togglePlayPause() {

            if (!player) return;

            

            if (isPlaying) {

                player.pauseVideo();

            } else {

                player.playVideo();

            }

        }

        

        // ì´ì „ ê³¡

        function playPrevious() {

            if (currentTrackIndex > 0) {

                playTrack(currentTrackIndex - 1);

            }

        }

        

        // ë‹¤ìŒ ê³¡

        function playNext() {

            if (currentTrackIndex < currentPlaylist.length - 1) {

                playTrack(currentTrackIndex + 1);

            }

        }

        

        // ì¬ìƒ/ì¼ì‹œì •ì§€ ë²„íŠ¼ ì—…ë°ì´íŠ¸

        function updatePlayPauseButton() {

            const btn = document.getElementById('playPauseBtn');

            btn.textContent = isPlaying ? 'â¸' : 'â–¶';

        }

        

        // í™œì„± íŠ¸ë™ í‘œì‹œ

        function updateActiveTrack(index) {

            const musicItems = document.querySelectorAll('.music-item');

            musicItems.forEach((item, i) => {

                if (i === index) {

                    item.classList.add('active');

                } else {

                    item.classList.remove('active');

                }

            });

        }

        

        // í˜ì´ì§€ ì–¸ë¡œë“œ ì‹œ í´ë§ ì¤‘ì§€

        window.addEventListener('beforeunload', stopPolling);

    </script>

</body>

</html>


            try {

                const response = await fetch(`/api/conversations/${conversationId}/end`, {

                    method: 'PUT'

                });

                

                const data = await response.json();

                

                document.getElementById('endResult').style.display = 'block';

                document.getElementById('endResult').textContent = JSON.stringify(data, null, 2);

                

                if (data.success) {

                    // ëŒ€í™” ë©”ì‹œì§€ í‘œì‹œ

                    displayMessages(data.messages);

                    

                    // í´ë§ ì‹œì‘

                    startPolling();

                }

                

            } catch (error) {

                document.getElementById('endResult').style.display = 'block';

                document.getElementById('endResult').textContent = 'ì˜¤ë¥˜: ' + error.message;

            }

        }

        

        // ëŒ€í™” ë©”ì‹œì§€ í‘œì‹œ

        function displayMessages(messages) {

            const endResult = document.getElementById('endResult');

            endResult.innerHTML = '<h3>ğŸ“ ëŒ€í™” ë‚´ìš©</h3>';

            

            messages.forEach((message, index) => {

                const messageDiv = document.createElement('div');

                messageDiv.style.marginBottom = '10px';

                messageDiv.style.padding = '10px';

                messageDiv.style.borderRadius = '5px';

                messageDiv.style.backgroundColor = message.senderType === 'USER' ? '#e3f2fd' : '#f3e5f5';

                

                const sender = message.senderType === 'USER' ? 'ğŸ‘¤ ì‚¬ìš©ì' : 'ğŸ¤– AI';

                messageDiv.innerHTML = `<strong>${sender}:</strong> ${message.content}`;

                

                endResult.appendChild(messageDiv);

            });

        }

        

        // 2. ì²˜ë¦¬ ìƒíƒœ í™•ì¸

        async function checkStatus() {

            if (!conversationId) {

                conversationId = document.getElementById('conversationId').value;

            }

            

            if (!conversationId) {

                alert('ëŒ€í™” IDë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');

                return;

            }

            

            try {

                const response = await fetch(`/api/conversations/${conversationId}/processing-status`);

                const data = await response.json();

                

                document.getElementById('statusResult').style.display = 'block';

                document.getElementById('statusResult').textContent = JSON.stringify(data, null, 2);

                

                // ìƒíƒœ í‘œì‹œ

                const statusDisplay = document.getElementById('statusDisplay');

                statusDisplay.style.display = 'block';

                statusDisplay.className = 'status';

                

                if (data.status === 'PROCESSING') {

                    statusDisplay.classList.add('processing');

                    statusDisplay.textContent = 'â³ ' + data.message;

                } else if (data.status === 'COMPLETED') {

                    statusDisplay.classList.add('completed');

                    statusDisplay.textContent = 'âœ… ' + data.message;

                    

                    // ì¼ê¸° ë²„íŠ¼ í™œì„±í™”

                    document.getElementById('diaryBtn').disabled = false;

                    

                    // í´ë§ ì¤‘ì§€

                    stopPolling();

                } else if (data.status === 'ERROR') {

                    statusDisplay.classList.add('error');

                    statusDisplay.textContent = 'âŒ ' + data.message;

                    stopPolling();

                }

                

            } catch (error) {

                document.getElementById('statusResult').style.display = 'block';

                document.getElementById('statusResult').textContent = 'ì˜¤ë¥˜: ' + error.message;

            }

        }

        

        // í´ë§ ì‹œì‘

        function startPolling() {

            if (pollingInterval) {

                clearInterval(pollingInterval);

            }

            

            pollingInterval = setInterval(checkStatus, 2000); // 2ì´ˆë§ˆë‹¤ í™•ì¸

            console.log('í´ë§ ì‹œì‘ë¨');

        }

        

        // í´ë§ ì¤‘ì§€

        function stopPolling() {

            if (pollingInterval) {

                clearInterval(pollingInterval);

                pollingInterval = null;

                console.log('í´ë§ ì¤‘ì§€ë¨');

            }

        }

        

        // 3. ì¼ê¸° ì¡°íšŒ

        async function getDiary() {

            if (!conversationId) {

                conversationId = document.getElementById('conversationId').value;

            }

            

            if (!conversationId) {

                alert('ëŒ€í™” IDë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');

                return;

            }

            

            try {

                const response = await fetch(`/api/conversations/${conversationId}/diary`);

                const data = await response.json();

                

                document.getElementById('diaryResult').style.display = 'block';

                document.getElementById('diaryResult').textContent = JSON.stringify(data, null, 2);

                

                if (data.success) {

                    // ì¼ê¸° ë‚´ìš© í‘œì‹œ

                    const diaryContent = document.getElementById('diaryContent');

                    diaryContent.style.display = 'block';

                    

                    let emotionHtml = '';

                    if (data.emotionSummary) {

                        emotionHtml = `

                            <h3>ğŸ˜Š ê°ì • ë¶„ì„ ìš”ì•½</h3>

                            <div class="summary-content">

                                <p><strong>ì£¼ìš” ê°ì •:</strong> ${data.emotionSummary.dominantEmotion}</p>

                                <p><strong>í‰ê·  ì‹ ë¢°ë„:</strong> ${data.emotionSummary.averageConfidence.toFixed(2)}</p>

                                <p><strong>ë¶„ì„ëœ ë©”ì‹œì§€ ìˆ˜:</strong> ${data.emotionSummary.analyzedMessageCount}</p>

                                <p><strong>ê°ì • ë¶„í¬:</strong> ${JSON.stringify(data.emotionSummary.emotionCounts)}</p>

                            </div>

                        `;

                    }

                    

                    diaryContent.innerHTML = `

                        <h3>ğŸ“‹ ëŒ€í™” ìš”ì•½</h3>

                        <div class="summary-content">${data.summary}</div>

                        

                        <h3>ğŸ“– ìƒì„±ëœ ì¼ê¸°</h3>

                        <div class="diary-content">${data.diary}</div>

                        

                        ${emotionHtml}

                    `;

                    

                    // ìŒì•… ì¶”ì²œ í‘œì‹œ

                    if (data.musicRecommendations && data.musicRecommendations.length > 0) {

                        displayMusicRecommendations(data.musicRecommendations);

                        // í”Œë ˆì´ë¦¬ìŠ¤íŠ¸ ì„¤ì •

                        currentPlaylist = data.musicRecommendations;

                    }

                }

                

            } catch (error) {

                document.getElementById('diaryResult').style.display = 'block';

                document.getElementById('diaryResult').textContent = 'ì˜¤ë¥˜: ' + error.message;

            }

        }

        

        // ìŒì•… ì¶”ì²œ í‘œì‹œ

        function displayMusicRecommendations(musicList) {

            const musicDiv = document.getElementById('musicRecommendations');

            const musicListDiv = document.getElementById('musicList');

            

            musicDiv.style.display = 'block';

            

            let html = '';

            musicList.forEach((music, index) => {

                html += `

                    <div class="music-item" onclick="playTrack(${index})">

                        <h4>ğŸµ ${music.title} - ${music.artist}</h4>

                        <p><strong>ë¶„ìœ„ê¸°:</strong> ${music.mood}</p>

                        <button onclick="event.stopPropagation(); playTrack(${index})" class="play-btn">

                            â–¶ï¸ ì¬ìƒí•˜ê¸°

                        </button>

                    </div>

                `;

            });

            

            musicListDiv.innerHTML = html;

        }

        

        // íŠ¸ë™ ì¬ìƒ

        function playTrack(index) {

            if (!currentPlaylist || currentPlaylist.length === 0) {

                alert('ì¬ìƒí•  ìŒì•…ì´ ì—†ìŠµë‹ˆë‹¤.');

                return;

            }

            

            currentTrackIndex = index;

            const track = currentPlaylist[index];

            

            if (!track.youtubeVideoId) {

                alert('ì´ ìŒì•…ì˜ YouTube IDë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');

                return;

            }

            

            // í”Œë ˆì´ì–´ í‘œì‹œ

            showPlayer();

            updatePlayerInfo(track, index);

            

            // YouTube Player ìƒì„± ë˜ëŠ” ì—…ë°ì´íŠ¸

            if (player) {

                player.loadVideoById(track.youtubeVideoId);

            } else {

                createYouTubePlayer(track.youtubeVideoId);

            }

            

            // í™œì„± íŠ¸ë™ í‘œì‹œ

            updateActiveTrack(index);

        }

        

        // YouTube Player ìƒì„±

        function createYouTubePlayer(videoId) {

            if (player) {

                player.destroy();

            }

            

            player = new YT.Player('player', {

                height: '0',

                width: '0',

                videoId: videoId,

                playerVars: {

                    'autoplay': 1,

                    'controls': 0,

                    'disablekb': 1,

                    'enablejsapi': 1,

                    'fs': 0,

                    'iv_load_policy': 3,

                    'modestbranding': 1,

                    'playsinline': 1,

                    'rel': 0,

                    'showinfo': 0

                },

                events: {

                    'onReady': onPlayerReady,

                    'onStateChange': onPlayerStateChange

                }

            });

        }

        

        // Player ì¤€ë¹„ ì™„ë£Œ

        function onPlayerReady(event) {

            console.log('YouTube Player ì¤€ë¹„ ì™„ë£Œ');

            isPlaying = true;

            updatePlayPauseButton();

        }

        

        // Player ìƒíƒœ ë³€ê²½

        function onPlayerStateChange(event) {

            if (event.data === YT.PlayerState.PLAYING) {

                isPlaying = true;

            } else if (event.data === YT.PlayerState.PAUSED) {

                isPlaying = false;

            } else if (event.data === YT.PlayerState.ENDED) {

                isPlaying = false;

                // ìë™ìœ¼ë¡œ ë‹¤ìŒ ê³¡ ì¬ìƒ

                playNext();

            }

            updatePlayPauseButton();

        }

        

        // í”Œë ˆì´ì–´ í‘œì‹œ

        function showPlayer() {

            document.getElementById('musicPlayer').style.display = 'block';

            document.body.style.paddingBottom = '120px'; // í”Œë ˆì´ì–´ ê³µê°„ í™•ë³´

        }

        

        // í”Œë ˆì´ì–´ ìˆ¨ê¸°ê¸°

        function closePlayer() {

            document.getElementById('musicPlayer').style.display = 'none';

            document.body.style.paddingBottom = '0';

            if (player) {

                player.pauseVideo();

            }

        }

        

        // í”Œë ˆì´ì–´ ì •ë³´ ì—…ë°ì´íŠ¸

        function updatePlayerInfo(track, index) {

            document.getElementById('playerTitle').textContent = track.title;

            document.getElementById('playerArtist').textContent = track.artist;

            document.getElementById('playlistIndicator').textContent = `${index + 1}/${currentPlaylist.length}`;

        }

        

        // ì¬ìƒ/ì¼ì‹œì •ì§€ í† ê¸€

        function togglePlayPause() {

            if (!player) return;

            

            if (isPlaying) {

                player.pauseVideo();

            } else {

                player.playVideo();

            }

        }

        

        // ì´ì „ ê³¡

        function playPrevious() {

            if (currentTrackIndex > 0) {

                playTrack(currentTrackIndex - 1);

            }

        }

        

        // ë‹¤ìŒ ê³¡

        function playNext() {

            if (currentTrackIndex < currentPlaylist.length - 1) {

                playTrack(currentTrackIndex + 1);

            }

        }

        

        // ì¬ìƒ/ì¼ì‹œì •ì§€ ë²„íŠ¼ ì—…ë°ì´íŠ¸

        function updatePlayPauseButton() {

            const btn = document.getElementById('playPauseBtn');

            btn.textContent = isPlaying ? 'â¸' : 'â–¶';

        }

        

        // í™œì„± íŠ¸ë™ í‘œì‹œ

        function updateActiveTrack(index) {

            const musicItems = document.querySelectorAll('.music-item');

            musicItems.forEach((item, i) => {

                if (i === index) {

                    item.classList.add('active');

                } else {

                    item.classList.remove('active');

                }

            });

        }

        

        // í˜ì´ì§€ ì–¸ë¡œë“œ ì‹œ í´ë§ ì¤‘ì§€

        window.addEventListener('beforeunload', stopPolling);

    </script>

</body>

</html>


