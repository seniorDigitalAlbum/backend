<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KoBERT ê°ì • ë¶„ì„ í…ŒìŠ¤íŠ¸</title>
    <style>
        body {
            font-family: 'Arial', sans-serif;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 30px;
        }
        .section {
            margin-bottom: 30px;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 8px;
            background-color: #fafafa;
        }
        .section h2 {
            color: #555;
            margin-top: 0;
        }
        .form-group {
            margin-bottom: 15px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #333;
        }
        input[type="text"], textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            box-sizing: border-box;
        }
        textarea {
            height: 100px;
            resize: vertical;
        }
        button {
            background-color: #007bff;
            color: white;
            padding: 12px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            margin-right: 10px;
            margin-bottom: 10px;
        }
        button:hover {
            background-color: #0056b3;
        }
        button:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }
        .response {
            margin-top: 15px;
            padding: 15px;
            border-radius: 4px;
            font-family: monospace;
            white-space: pre-wrap;
            max-height: 400px;
            overflow-y: auto;
        }
        .success {
            background-color: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }
        .error {
            background-color: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }
        .ai-message {
            background-color: #e7f3ff;
            border: 1px solid #b3d9ff;
            color: #0066cc;
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
        }
        .ai-message strong {
            color: #004499;
        }
        .user-message {
            background-color: #fff3cd;
            border: 1px solid #ffeaa7;
            color: #856404;
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
        }
        .user-message strong {
            color: #6c5ce7;
        }
        .emotion-result {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            color: #495057;
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
        }
        .emotion-result strong {
            color: #212529;
        }
        .conversation-log {
            max-height: 500px;
            overflow-y: auto;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 15px;
            background-color: #f8f9fa;
        }
        .conversation-entry {
            margin-bottom: 15px;
            padding: 10px;
            border-radius: 4px;
        }
        .conversation-entry.ai {
            background-color: #e3f2fd;
            border-left: 4px solid #2196f3;
        }
        .conversation-entry.user {
            background-color: #fff3e0;
            border-left: 4px solid #ff9800;
        }
        .conversation-entry.emotion {
            background-color: #f3e5f5;
            border-left: 4px solid #9c27b0;
        }
        .timestamp {
            font-size: 12px;
            color: #666;
            margin-bottom: 5px;
        }
        .emotion-badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: bold;
            margin-left: 10px;
        }
        .emotion-joy { background-color: #ffeb3b; color: #333; }
        .emotion-sadness { background-color: #2196f3; color: white; }
        .emotion-anger { background-color: #f44336; color: white; }
        .emotion-fear { background-color: #9c27b0; color: white; }
        .emotion-surprise { background-color: #ff9800; color: white; }
        .emotion-neutral { background-color: #9e9e9e; color: white; }
        .emotion-hurt { background-color: #e91e63; color: white; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ§  KoBERT ê°ì • ë¶„ì„ í…ŒìŠ¤íŠ¸</h1>
        
        <!-- íšŒìƒ ìš”ë²• ì§ˆë¬¸ í‘œì‹œ -->
        <div class="section">
            <h2>ğŸ“ íšŒìƒ ìš”ë²• ì§ˆë¬¸</h2>
            <div id="reminiscentQuestion" class="ai-message">
                <strong>AI:</strong> <span id="questionText">ì§ˆë¬¸ì„ ìƒì„±í•˜ëŠ” ì¤‘...</span>
            </div>
            <button onclick="generateNewQuestion()">ìƒˆ ì§ˆë¬¸ ìƒì„±</button>
        </div>

        <!-- ì‚¬ìš©ì ì…ë ¥ -->
        <div class="section">
            <h2>ğŸ’¬ ì‚¬ìš©ì ì‘ë‹µ ì…ë ¥</h2>
            <div class="form-group">
                <label for="userInput">ì‚¬ìš©ì ì‘ë‹µ:</label>
                <textarea id="userInput" placeholder="íšŒìƒ ìš”ë²• ì§ˆë¬¸ì— ëŒ€í•œ ë‹µë³€ì„ ì…ë ¥í•˜ì„¸ìš”..."></textarea>
            </div>
            <button onclick="analyzeEmotion()">ê°ì • ë¶„ì„ ì‹¤í–‰</button>
            <button onclick="analyzeEmotionAlternative()">ëŒ€ì•ˆ í˜•ì‹ ì‹œë„</button>
            <button onclick="testGPTAPI()">GPT API í…ŒìŠ¤íŠ¸</button>
            <button onclick="clearInput()">ì…ë ¥ ì´ˆê¸°í™”</button>
        </div>

        <!-- ê°ì • ë¶„ì„ ê²°ê³¼ -->
        <div class="section">
            <h2>ğŸ“Š ê°ì • ë¶„ì„ ê²°ê³¼</h2>
            <div id="emotionResults"></div>
        </div>

        <!-- ëŒ€í™” ë¡œê·¸ -->
        <div class="section">
            <h2>ğŸ“‹ ëŒ€í™” ë¡œê·¸</h2>
            <div id="conversationLog" class="conversation-log"></div>
            <button onclick="clearConversation()">ëŒ€í™” ë¡œê·¸ ì´ˆê¸°í™”</button>
        </div>
    </div>

    <script>
        const KOBERT_API_URL = 'http://35.202.26.247:8001/predict_emotion';
        let conversationCount = 0;
        
        // ëŒ€í™” íˆìŠ¤í† ë¦¬ ê´€ë¦¬
        let conversationHistory = {
            prevUser: '',
            prevSys: '',
            currentUser: '',
            stepIndex: 1,           // ëŒ€í™” í„´ ë²ˆí˜¸
            topicRoot: 'ê³¼ê±°ì˜ ì†Œì¤‘í•œ ê¸°ì–µ',  // ëŒ€í™” ì£¼ì œ
            targetAnchor: null,     // ì¶”ì¶œëœ ì•µì»¤
            facetHistory: []        // ì‚¬ìš©ëœ ì„¸ë¶€í‚¤ íˆìŠ¤í† ë¦¬
        };

        // íšŒìƒ ìš”ë²• ì§ˆë¬¸ ë¦¬ìŠ¤íŠ¸
        const reminiscentQuestions = [
            "ì–´ë¦° ì‹œì ˆ ê°€ì¥ ê¸°ì–µì— ë‚¨ëŠ” ë†€ì´ëŠ” ë¬´ì—‡ì¸ê°€ìš”?",
            "ì²˜ìŒìœ¼ë¡œ ì§ì¥ì— ë‹¤ë‹ˆê²Œ ë˜ì—ˆì„ ë•Œì˜ ê¸°ë¶„ì€ ì–´ë• ë‚˜ìš”?",
            "ê°€ì¥ ì¸ìƒ ê¹Šì—ˆë˜ ì—¬í–‰ì€ ì–¸ì œ, ì–´ë””ì˜€ë‚˜ìš”?",
            "ì–´ë¦° ì‹œì ˆ ê°€ì¥ ì¢‹ì•„í–ˆë˜ ìŒì‹ì€ ë¬´ì—‡ì¸ê°€ìš”?",
            "ì²«ì‚¬ë‘ì„ ê¸°ì–µí•˜ì‹œë‚˜ìš”? ì–´ë–¤ ê¸°ë¶„ì´ì—ˆë‚˜ìš”?",
            "ê°€ì¡±ê³¼ í•¨ê»˜í•œ ê°€ì¥ í–‰ë³µí–ˆë˜ ìˆœê°„ì€ ì–¸ì œì¸ê°€ìš”?",
            "ì–´ë¦° ì‹œì ˆ ê°€ì¥ ì¹œí–ˆë˜ ì¹œêµ¬ëŠ” ëˆ„êµ¬ì˜€ë‚˜ìš”?",
            "ì²˜ìŒìœ¼ë¡œ ì§‘ì„ ë§ˆë ¨í–ˆì„ ë•Œì˜ ê¸°ë¶„ì€ ì–´ë• ë‚˜ìš”?",
            "ê°€ì¥ ê¸°ì–µì— ë‚¨ëŠ” ìƒì¼ì€ ì–¸ì œì¸ê°€ìš”?",
            "ì–´ë¦° ì‹œì ˆ ê°€ì¥ ë¬´ì„œì› ë˜ ê²½í—˜ì€ ë¬´ì—‡ì¸ê°€ìš”?",
            "ê°€ì¥ ìë‘ìŠ¤ëŸ¬ì› ë˜ ìˆœê°„ì€ ì–¸ì œì¸ê°€ìš”?",
            "ì–´ë¦° ì‹œì ˆ ê°€ì¥ ì¢‹ì•„í–ˆë˜ ì¥ë‚œê°ì€ ë¬´ì—‡ì¸ê°€ìš”?",
            "ê°€ì¡±ê³¼ í•¨ê»˜í•œ ê°€ì¥ ë§›ìˆì—ˆë˜ ì‹ì‚¬ëŠ” ì–¸ì œì¸ê°€ìš”?",
            "ì²˜ìŒìœ¼ë¡œ ìë™ì°¨ë¥¼ ìš´ì „í–ˆì„ ë•Œì˜ ê¸°ë¶„ì€ ì–´ë• ë‚˜ìš”?",
            "ê°€ì¥ ê¸°ì–µì— ë‚¨ëŠ” ì„ ìƒë‹˜ì€ ëˆ„êµ¬ì˜€ë‚˜ìš”?",
            "ì–´ë¦° ì‹œì ˆ ê°€ì¥ ì¢‹ì•„í–ˆë˜ ê³„ì ˆì€ ì–¸ì œì¸ê°€ìš”?",
            "ê°€ì¡±ê³¼ í•¨ê»˜í•œ ê°€ì¥ ì¬ë¯¸ìˆì—ˆë˜ ê²Œì„ì€ ë¬´ì—‡ì¸ê°€ìš”?",
            "ì²˜ìŒìœ¼ë¡œ í•´ì™¸ì—¬í–‰ì„ ê°”ì„ ë•Œì˜ ê²½í—˜ì€ ì–´ë• ë‚˜ìš”?",
            "ê°€ì¥ ê¸°ì–µì— ë‚¨ëŠ” ì„ ë¬¼ì„ ë°›ì•˜ë˜ ìˆœê°„ì€ ì–¸ì œì¸ê°€ìš”?",
            "ì–´ë¦° ì‹œì ˆ ê°€ì¥ ì¢‹ì•„í–ˆë˜ ë™ë¬¼ì€ ë¬´ì—‡ì¸ê°€ìš”?"
        ];

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì²« ë²ˆì§¸ ì§ˆë¬¸ ìƒì„±
        window.onload = function() {
            generateNewQuestion();
        };

        // ìƒˆ ì§ˆë¬¸ ìƒì„±
        function generateNewQuestion() {
            const randomIndex = Math.floor(Math.random() * reminiscentQuestions.length);
            const question = reminiscentQuestions[randomIndex];
            document.getElementById('questionText').textContent = question;
            
            // ëŒ€í™” íˆìŠ¤í† ë¦¬ ì´ˆê¸°í™”
            conversationHistory = {
                prevUser: '',
                prevSys: '',
                currentUser: '',
                stepIndex: 1,
                topicRoot: 'ê³¼ê±°ì˜ ì†Œì¤‘í•œ ê¸°ì–µ',
                targetAnchor: null,
                facetHistory: []
            };
            
            // ëŒ€í™” ë¡œê·¸ì— AI ì§ˆë¬¸ ì¶”ê°€
            addToConversationLog('ai', question);
        }

        // ê°ì • ë¶„ì„ ì‹¤í–‰
        async function analyzeEmotion() {
            const userInput = document.getElementById('userInput').value.trim();
            
            if (!userInput) {
                alert('ì‚¬ìš©ì ì‘ë‹µì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }

            try {
                // KoBERT API í˜¸ì¶œ - ì—¬ëŸ¬ í˜•ì‹ ì‹œë„
                let requestBody;
                
                // í˜•ì‹ 1: ëŒ€í™” íˆìŠ¤í† ë¦¬ í¬í•¨
                requestBody = {
                    prev_user: conversationHistory.prevUser,
                    prev_sys: conversationHistory.prevSys,
                    curr_user: userInput
                };
                
                console.log('KoBERT API ìš”ì²­ ë°ì´í„°:', requestBody);
                
                const response = await fetch(KOBERT_API_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(requestBody)
                });

                if (!response.ok) {
                    // 422 ì—ëŸ¬ì˜ ê²½ìš° ìƒì„¸ ì •ë³´ í™•ì¸
                    let errorMessage = `HTTP error! status: ${response.status}`;
                    try {
                        const errorData = await response.json();
                        console.error('KoBERT API ì—ëŸ¬ ìƒì„¸:', errorData);
                        errorMessage += ` - ${JSON.stringify(errorData)}`;
                    } catch (e) {
                        console.error('ì—ëŸ¬ ì‘ë‹µ íŒŒì‹± ì‹¤íŒ¨:', e);
                    }
                    throw new Error(errorMessage);
                }

                const result = await response.json();
                console.log('KoBERT API ì‘ë‹µ:', result);
                
                // ê°ì • ë¶„ì„ ê²°ê³¼ í‘œì‹œ
                displayEmotionResult(userInput, result);
                
                // ëŒ€í™” ë¡œê·¸ì— ì‚¬ìš©ì ì‘ë‹µê³¼ ê°ì • ë¶„ì„ ê²°ê³¼ ì¶”ê°€
                addToConversationLog('user', userInput);
                addToConversationLog('emotion', result);
                
                // ì…ë ¥ ì´ˆê¸°í™”
                document.getElementById('userInput').value = '';
                
            } catch (error) {
                console.error('ê°ì • ë¶„ì„ ì˜¤ë¥˜:', error);
                displayEmotionError(userInput, error.message);
            }
        }

        // ê°ì • ë¶„ì„ ê²°ê³¼ í‘œì‹œ
        function displayEmotionResult(userInput, result) {
            const resultsContainer = document.getElementById('emotionResults');
            
            const resultDiv = document.createElement('div');
            resultDiv.className = 'emotion-result';
            
            const timestamp = new Date().toLocaleTimeString();
            
            // KoBERT API ì‘ë‹µ í˜•ì‹ì— ë§ê²Œ ê°ì • ì¶”ì¶œ
            const emotion = result.predicted_label || result.emotion || 'unknown';
            const confidence = result.confidence || 0;
            const confidencePercent = Math.round(confidence * 100);
            
            resultDiv.innerHTML = `
                <div class="timestamp">${timestamp}</div>
                <div><strong>ì…ë ¥ í…ìŠ¤íŠ¸:</strong> "${userInput}"</div>
                <div><strong>ê°ì •:</strong> ${emotion} <span class="emotion-badge emotion-${emotion}">${emotion}</span></div>
                <div><strong>ì‹ ë¢°ë„:</strong> ${confidencePercent}%</div>
                <div><strong>ì›ë³¸ ì‘ë‹µ:</strong> ${JSON.stringify(result, null, 2)}</div>
                <button class="gpt-response-btn" data-emotion="${emotion}" data-confidence="${confidence}" data-user-input="${userInput.replace(/"/g, '&quot;')}" style="margin-top: 10px; background-color: #28a745;">GPT íšŒìƒ ìš”ë²• ì‘ë‹µ ìƒì„±</button>
            `;
            
            // GPT ì‘ë‹µ ë²„íŠ¼ì— ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
            const gptBtn = resultDiv.querySelector('.gpt-response-btn');
            gptBtn.addEventListener('click', function() {
                const emotion = this.getAttribute('data-emotion');
                const confidence = parseFloat(this.getAttribute('data-confidence'));
                const userInput = this.getAttribute('data-user-input');
                generateGPTResponse(emotion, confidence, userInput);
            });
            
            // ìµœì‹  ê²°ê³¼ë¥¼ ë§¨ ìœ„ì— ì¶”ê°€
            resultsContainer.insertBefore(resultDiv, resultsContainer.firstChild);
            
            // ìµœëŒ€ 10ê°œ ê²°ê³¼ë§Œ ìœ ì§€
            while (resultsContainer.children.length > 10) {
                resultsContainer.removeChild(resultsContainer.lastChild);
            }
        }

        // ê°ì • ë¶„ì„ ì—ëŸ¬ í‘œì‹œ
        function displayEmotionError(userInput, errorMessage) {
            const resultsContainer = document.getElementById('emotionResults');
            
            const errorDiv = document.createElement('div');
            errorDiv.className = 'emotion-result error';
            
            const timestamp = new Date().toLocaleTimeString();
            
            errorDiv.innerHTML = `
                <div class="timestamp">${timestamp}</div>
                <div><strong>ì…ë ¥ í…ìŠ¤íŠ¸:</strong> "${userInput}"</div>
                <div><strong>ì—ëŸ¬:</strong> ${errorMessage}</div>
            `;
            
            // ìµœì‹  ì—ëŸ¬ë¥¼ ë§¨ ìœ„ì— ì¶”ê°€
            resultsContainer.insertBefore(errorDiv, resultsContainer.firstChild);
            
            // ìµœëŒ€ 10ê°œ ê²°ê³¼ë§Œ ìœ ì§€
            while (resultsContainer.children.length > 10) {
                resultsContainer.removeChild(resultsContainer.lastChild);
            }
        }

        // ëŒ€í™” ë¡œê·¸ì— í•­ëª© ì¶”ê°€
        function addToConversationLog(type, content) {
            const logContainer = document.getElementById('conversationLog');
            const timestamp = new Date().toLocaleTimeString();
            
            const entryDiv = document.createElement('div');
            entryDiv.className = `conversation-entry ${type}`;
            
            if (type === 'ai') {
                entryDiv.innerHTML = `
                    <div class="timestamp">${timestamp}</div>
                    <div><strong>AI ì§ˆë¬¸:</strong> ${content}</div>
                `;
            } else if (type === 'user') {
                entryDiv.innerHTML = `
                    <div class="timestamp">${timestamp}</div>
                    <div><strong>ì‚¬ìš©ì:</strong> ${content}</div>
                `;
            } else if (type === 'emotion') {
                const emotion = content.predicted_label || content.emotion || 'unknown';
                const confidencePercent = Math.round((content.confidence || 0) * 100);
                entryDiv.innerHTML = `
                    <div class="timestamp">${timestamp}</div>
                    <div><strong>ê°ì • ë¶„ì„:</strong> ${emotion} <span class="emotion-badge emotion-${emotion}">${emotion}</span> (${confidencePercent}%)</div>
                `;
            } else if (type === 'gpt') {
                entryDiv.innerHTML = `
                    <div class="timestamp">${timestamp}</div>
                    <div><strong>ğŸ¤– GPT íšŒìƒ ìš”ë²• ì‘ë‹µ:</strong> ${content}</div>
                `;
            }
            
            logContainer.appendChild(entryDiv);
            logContainer.scrollTop = logContainer.scrollHeight;
        }

        // ëŒ€ì•ˆ í˜•ì‹ìœ¼ë¡œ ê°ì • ë¶„ì„ ì‹¤í–‰
        async function analyzeEmotionAlternative() {
            const userInput = document.getElementById('userInput').value.trim();
            
            if (!userInput) {
                alert('ì‚¬ìš©ì ì‘ë‹µì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }

            try {
                // ëŒ€ì•ˆ í˜•ì‹ë“¤ ì‹œë„
                const alternativeFormats = [
                    // í˜•ì‹ 1: ë¹ˆ ë¬¸ìì—´ ì‚¬ìš©
                    {
                        prev_user: "",
                        prev_sys: "",
                        curr_user: userInput
                    },
                    // í˜•ì‹ 2: text í•„ë“œ í¬í•¨
                    {
                        text: userInput,
                        prev_user: null,
                        prev_sys: null,
                        curr_user: userInput
                    },
                    // í˜•ì‹ 3: ë‹¨ìˆœ textë§Œ
                    {
                        text: userInput
                    },
                    // í˜•ì‹ 4: ë‹¤ë¥¸ í•„ë“œëª…
                    {
                        previous_user: null,
                        previous_system: null,
                        current_user: userInput
                    }
                ];

                for (let i = 0; i < alternativeFormats.length; i++) {
                    const format = alternativeFormats[i];
                    console.log(`ëŒ€ì•ˆ í˜•ì‹ ${i + 1} ì‹œë„:`, format);
                    
                    try {
                        const response = await fetch(KOBERT_API_URL, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify(format)
                        });

                        if (response.ok) {
                            const result = await response.json();
                            console.log(`ëŒ€ì•ˆ í˜•ì‹ ${i + 1} ì„±ê³µ:`, result);
                            
                            // ì„±ê³µí•œ í˜•ì‹ìœ¼ë¡œ ê²°ê³¼ í‘œì‹œ
                            displayEmotionResult(userInput, result);
                            addToConversationLog('user', userInput);
                            addToConversationLog('emotion', result);
                            
                            document.getElementById('userInput').value = '';
                            return;
                        } else {
                            const errorData = await response.json();
                            console.log(`ëŒ€ì•ˆ í˜•ì‹ ${i + 1} ì‹¤íŒ¨:`, errorData);
                        }
                    } catch (e) {
                        console.log(`ëŒ€ì•ˆ í˜•ì‹ ${i + 1} ì˜ˆì™¸:`, e.message);
                    }
                }
                
                throw new Error('ëª¨ë“  ëŒ€ì•ˆ í˜•ì‹ì´ ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                
            } catch (error) {
                console.error('ëŒ€ì•ˆ ê°ì • ë¶„ì„ ì˜¤ë¥˜:', error);
                displayEmotionError(userInput, error.message);
            }
        }

        // GPT íšŒìƒ ìš”ë²• ì‘ë‹µ ìƒì„±
        async function generateGPTResponse(emotion, confidence, userInput) {
            try {
                console.log('GPT ì‘ë‹µ ìƒì„± ì‹œì‘:', { emotion, confidence, userInput });
                
                // ìš”ì²­ ë°ì´í„° ì¤€ë¹„ (ëŒ€í™” íˆìŠ¤í† ë¦¬ í¬í•¨)
                const requestData = {
                    emotion: emotion,
                    confidence: confidence,
                    prevUser: conversationHistory.prevUser,
                    prevSys: conversationHistory.prevSys,
                    currUser: userInput,
                    topicRoot: conversationHistory.topicRoot,
                    stepIndex: conversationHistory.stepIndex,
                    // facetHistoryë¥¼ ì‰¼í‘œë¡œ êµ¬ë¶„ëœ ë¬¸ìì—´ë¡œ ë³€í™˜
                    facetHistory: conversationHistory.facetHistory.join(','),
                    // targetAnchorë¥¼ ê°œë³„ íŒŒë¼ë¯¸í„°ë¡œ ì „ë‹¬
                    targetAnchorType: conversationHistory.targetAnchor?.type || '',
                    targetAnchorText: conversationHistory.targetAnchor?.text || ''
                };
                
                console.log('GPT API ìš”ì²­ ë°ì´í„°:', requestData);
                console.log('- facetHistory (array):', conversationHistory.facetHistory);
                console.log('- targetAnchor:', conversationHistory.targetAnchor);
                
                // GPT API í˜¸ì¶œ
                const response = await fetch('/api/gpt/generate-simple', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: new URLSearchParams(requestData)
                });

                console.log('GPT API ì‘ë‹µ ìƒíƒœ:', response.status, response.statusText);

                if (!response.ok) {
                    // ì—ëŸ¬ ì‘ë‹µ ìƒì„¸ ì •ë³´ í™•ì¸
                    let errorMessage = `HTTP error! status: ${response.status}`;
                    try {
                        const errorData = await response.json();
                        console.error('GPT API ì—ëŸ¬ ìƒì„¸:', errorData);
                        errorMessage += ` - ${JSON.stringify(errorData)}`;
                    } catch (e) {
                        console.error('ì—ëŸ¬ ì‘ë‹µ íŒŒì‹± ì‹¤íŒ¨:', e);
                        const errorText = await response.text();
                        console.error('ì—ëŸ¬ ì‘ë‹µ í…ìŠ¤íŠ¸:', errorText);
                        errorMessage += ` - ${errorText}`;
                    }
                    throw new Error(errorMessage);
                }

                const result = await response.json();
                console.log('GPT ì‘ë‹µ ê²°ê³¼:', result);
                
                if (result.success) {
                    // GPT ì‘ë‹µ í‘œì‹œ
                    displayGPTResponse(result.aiResponse, emotion, confidence);
                    
                    // ëŒ€í™” ë¡œê·¸ì— GPT ì‘ë‹µ ì¶”ê°€
                    addToConversationLog('gpt', result.aiResponse);
                    
                    // ëŒ€í™” íˆìŠ¤í† ë¦¬ ì—…ë°ì´íŠ¸
                    conversationHistory.prevUser = userInput;
                    conversationHistory.prevSys = result.aiResponse;
                    conversationHistory.currentUser = '';
                    
                    // stepIndex ì¦ê°€ (ë‹¤ìŒ í„´)
                    conversationHistory.stepIndex = result.next_step_index || (conversationHistory.stepIndex + 1);
                    
                    // target_anchor ì €ì¥ (stepIndex=1ì¼ ë•Œë§Œ ë°˜í™˜ë¨)
                    if (result.target_anchor) {
                        conversationHistory.targetAnchor = result.target_anchor;
                        console.log('âœ¨ Target Anchor ì¶”ì¶œë¨:', result.target_anchor);
                    }
                    
                    // facet_history ì—…ë°ì´íŠ¸ (ë°±ì—”ë“œì—ì„œ ê´€ë¦¬ëœ íˆìŠ¤í† ë¦¬ ì‚¬ìš©)
                    if (result.facet_history && Array.isArray(result.facet_history)) {
                        conversationHistory.facetHistory = result.facet_history;
                        console.log('ğŸ“ Facet History ì—…ë°ì´íŠ¸:', result.facet_history);
                    } else if (result.facet_key_used) {
                        // ë°±ì—”ë“œ ì‘ë‹µì— facet_historyê°€ ì—†ìœ¼ë©´ ì§ì ‘ ì¶”ê°€
                        if (!conversationHistory.facetHistory.includes(result.facet_key_used)) {
                            conversationHistory.facetHistory.push(result.facet_key_used);
                        }
                    }
                    
                    console.log('ğŸ”„ ëŒ€í™” íˆìŠ¤í† ë¦¬ ì—…ë°ì´íŠ¸:', conversationHistory);
                    console.log('  â””â”€ stepIndex:', conversationHistory.stepIndex);
                    console.log('  â””â”€ ruleStep:', result.ruleStep);
                    console.log('  â””â”€ facet_key_used:', result.facet_key_used);
                    console.log('  â””â”€ facetHistory:', conversationHistory.facetHistory);
                } else {
                    throw new Error(result.error || 'GPT ì‘ë‹µ ìƒì„± ì‹¤íŒ¨');
                }
                
            } catch (error) {
                console.error('GPT ì‘ë‹µ ìƒì„± ì˜¤ë¥˜:', error);
                alert('GPT ì‘ë‹µ ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
            }
        }

        // GPT ì‘ë‹µ í‘œì‹œ
        function displayGPTResponse(aiResponse, emotion, confidence) {
            const resultsContainer = document.getElementById('emotionResults');
            
            const resultDiv = document.createElement('div');
            resultDiv.className = 'emotion-result';
            resultDiv.style.backgroundColor = '#e8f5e8';
            resultDiv.style.borderColor = '#4caf50';
            
            const timestamp = new Date().toLocaleTimeString();
            const confidencePercent = Math.round(confidence * 100);
            
            resultDiv.innerHTML = `
                <div class="timestamp">${timestamp}</div>
                <div><strong>ğŸ¤– GPT íšŒìƒ ìš”ë²• ì‘ë‹µ:</strong></div>
                <div style="margin: 10px 0; padding: 10px; background-color: #f0f8f0; border-radius: 4px; font-style: italic;">
                    "${aiResponse}"
                </div>
                <div><strong>ê¸°ë°˜ ê°ì •:</strong> ${emotion} (${confidencePercent}%)</div>
            `;
            
            // ìµœì‹  ê²°ê³¼ë¥¼ ë§¨ ìœ„ì— ì¶”ê°€
            resultsContainer.insertBefore(resultDiv, resultsContainer.firstChild);
            
            // ìµœëŒ€ 10ê°œ ê²°ê³¼ë§Œ ìœ ì§€
            while (resultsContainer.children.length > 10) {
                resultsContainer.removeChild(resultsContainer.lastChild);
            }
        }

        // GPT API í…ŒìŠ¤íŠ¸
        async function testGPTAPI() {
            try {
                console.log('GPT API í…ŒìŠ¤íŠ¸ ì‹œì‘');
                
                const testData = {
                    emotion: 'ê¸°ì¨',
                    confidence: 0.95,
                    prevUser: '',
                    prevSys: '',
                    currUser: 'í…ŒìŠ¤íŠ¸ ë©”ì‹œì§€ì…ë‹ˆë‹¤.'
                };
                
                console.log('GPT API í…ŒìŠ¤íŠ¸ ë°ì´í„°:', testData);
                
                const response = await fetch('/api/gpt/generate-simple', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: new URLSearchParams(testData)
                });

                console.log('GPT API í…ŒìŠ¤íŠ¸ ì‘ë‹µ ìƒíƒœ:', response.status, response.statusText);

                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('GPT API í…ŒìŠ¤íŠ¸ ì—ëŸ¬:', errorText);
                    alert('GPT API í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨: ' + response.status + ' - ' + errorText);
                    return;
                }

                const result = await response.json();
                console.log('GPT API í…ŒìŠ¤íŠ¸ ì„±ê³µ:', result);
                
                if (result.success) {
                    alert('GPT API í…ŒìŠ¤íŠ¸ ì„±ê³µ!\nì‘ë‹µ: ' + result.aiResponse);
                } else {
                    alert('GPT API í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨: ' + (result.error || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'));
                }
                
            } catch (error) {
                console.error('GPT API í…ŒìŠ¤íŠ¸ ì˜¤ë¥˜:', error);
                alert('GPT API í…ŒìŠ¤íŠ¸ ì¤‘ ì˜¤ë¥˜: ' + error.message);
            }
        }

        // ì…ë ¥ ì´ˆê¸°í™”
        function clearInput() {
            document.getElementById('userInput').value = '';
        }

        // ëŒ€í™” ë¡œê·¸ ì´ˆê¸°í™”
        function clearConversation() {
            document.getElementById('conversationLog').innerHTML = '';
            conversationCount = 0;
            
            // ëŒ€í™” íˆìŠ¤í† ë¦¬ë„ ì´ˆê¸°í™”
            conversationHistory = {
                prevUser: '',
                prevSys: '',
                currentUser: '',
                stepIndex: 1,
                topicRoot: 'ê³¼ê±°ì˜ ì†Œì¤‘í•œ ê¸°ì–µ',
                targetAnchor: null,
                facetHistory: []
            };
            
            console.log('ëŒ€í™” íˆìŠ¤í† ë¦¬ ì´ˆê¸°í™”:', conversationHistory);
        }

        // Enter í‚¤ë¡œ ê°ì • ë¶„ì„ ì‹¤í–‰
        document.getElementById('userInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter' && e.ctrlKey) {
                analyzeEmotion();
            }
        });
    </script>
</body>
</html>
